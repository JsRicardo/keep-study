# 首屏渲染性能优化

> 面试题： 说说你们首屏加载性能优化怎么做的

性能优化主要可以从三个方面去做：

1. 资源加载
2. 页面渲染
3. 感知优化

其实前端在首页加载性能优化上能做的不多。

前端选手做的 webpack 打包优化，异步组件等，能够压缩的资源体积有限，尤其是在开启了`GZIP`的情况之下。在现代网络环境下，对资源加载速度微乎其微。

但是放开视野，从整个架构的角度去看待问题，你会发现：

- 影响资源加载的除了静态资源加载，还有接口交互。而接口交互中，SQL 查询、第三方接口交互才是影响数据来源的重点
- CDN 服务器，网络解析也是一大影响点。CDN 服务器可以让资源离用户更近，这样网络交互时间自然就会缩短。试想一下访问国外站点和访问国内站点的速度对比
- HTTP2，让运维兄弟支持 HTTP2 开启多路复用，避免队头堵塞
- 缓存：不管是 ETag Cache-Control，让运维兄弟支持一下，不请求网络资源，直接使用本地缓存是最快的
- GZip：让运维兄弟给资源开上压缩，降低资源体积

## 资源加载

资源加载又分为静态资源加载和接口资源加载

### 静态资源加载

所有的静态资源加载，都可以从减小加载体积、资源缓存、多域名并发加载入手处理

在前端，静态资源加载耗资源最多的的主要是图片，在首页加载场景，为了避免图片加载导致的闪屏，我们可以从几个方面着手优化

- **懒加载**：只加载可视区域内的图片
- **占位图**：给定图片位置固定宽高，优先加载低像素占位图，图片即将进入可视区域再加载原图
- **多域名并发**：同一个域名由于 TCP 连接的限制，最多只能开启 6 个连接，所以理论上，资源服务器 CDN 域名越多，带宽使用率就越高
- **缓存**：图片资源一般不会变化，max-age 打满

代码资源，与图片资源类似的处理方式

- **懒加载**：异步引入组件，将组件使用 import 的动态导入能力导入，以拆分 js chunk，使 index.js 尽可能小
- **tree shaking**：尽量避免使用 require，引入支持 esm 的包，如 lodash-es 替换 lodash；
- **split-chunk**：将 js 更合理的划分 chunk，减小加载体积
- **缓存**：给打包产物加上 hash，若内容并无变化，可直接使用缓存。注：**index.html 不可使用缓存**
- **prefetch**：在资源标签上显示标注预加载，优先加载资源

### 接口网络 IO

IO 操作是非常消耗性能的。像第三方的接口网络 IO，无法控制其响应速度；自家接口在开发时应注意慢 SQL 产生的 IO 操作

- **避免慢 SQL**：如果查询数据时，sql 没有优化好，导致的性能影响是非常巨大的
- **只查询有效数据**：前端整理好需要的数据，单独定制接口，避免无效的查询，导致接口响应变慢
- **接口组合**：必要数据可能来自多个接口，可以由后端或者 BFF 层做接口整合。虽然这样响应速度取决于最慢的接口，但这本身就是必要数据
- **非必要数据**：在必要数据接口加载完成后，即可放开页面操作权限。继续请求非必要数据接口

## 页面渲染

此处更多是平时开发习惯的影响

1. 尽量在 created 生命周期请求接口，防止页面抖动
2. 动画优化，使用 transform，在合成层处理动画，可以防止 js 占用渲染主线程导致的动画卡顿
3. will-change 显示告诉浏览器使用 GPU 加速
4. 大任务使用 worker 线程处理，如大文件分片计算 hash 等
5. requestAnimationFrame 做动画，是在渲染前执行的
6. MutationObserver 监控 dom 变化
7. intersectionObserver 监听 dom 是否进入视窗
8. requestIdleCallback 在渲染线程空闲时做一些操作，一帧大约 16ms，若无渲染任务，最大可以分得 50ms 的任务处理时间

## 体验优化

1. 增加开屏动画，或者增加骨架屏，让用户能够看到内容，减少白屏带来的心意厌烦
2. 长列表虚拟渲染，只加载视窗可见的内容，减少网络资源加载，减少 DOM 节点，减少内存压力，增加响应速度
3. 处理 300ms 点击延迟，浏览器默认行为，为了判断双击会在 click 事件时延迟 300ms 响应，可以固定视窗大小，或者使用 fastclick
