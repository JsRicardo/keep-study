# 从输入域名到页面静态资源完全加载完发生了什么

## 1、用户输入

当用户在浏览器url栏输入关键字，并且确认（回车）之后，页面应该加载新的资源了，应该进入新的页面。不过在这个过程之前，还是可以进行拦截，通过浏览器暴露出的`beforeunload` API，`beforeunload`允许页面在加载新资源前，进行一些处理，并且询问用户是否离开页面。这个应用挺常见的，vue的路由守卫也用到了。

## URL请求过程

在发送请求前，`网络进程`会查找缓存，如果有缓存，那么直接返回缓存给`浏览器进程`。

如果没有缓存，那么会进入`网络请求流程`，流程如下：

第一步：将URL解析成IP地址（DNS解析），如果请求是HTTPS的，还需要建立`TLS`链接

    1. 其中，DNS也有几步缓存：浏览器缓存，hosts文件
    2. 如果本地域名服务器没有缓存，则向上层服务器查找域名
    3. TCP三次握手，HTTP。TLS握手，HTTPS。

具体的内容在网络篇中进行分析。

第二步： 利用IP和服务器建立链接，建立链接之后，浏览器开始构建请求头，请求行，将和该域名相关的所有`cookie`添加进入请求头，向服务器发送构建好的请求信息。

    1. 数据在进入服务端之前可能还会经过`负载均衡服务器`（如果有的话），该服务器的作用就是将请求信息合理的分发到多个服务器，以减低服务器压力。
    2. 假设此时服务端响应了一个HTML页面。
    3. 此时浏览器会判断响应码，如果是200，那就OK继续解析；如果是400或者500，那么浏览器会报错，进入错误页面；如果是300，浏览器会进行重定向，这里会有一个重定向计数器，如果重定向次数超过限制，浏览器也是会报错的。
    4. 浏览器开始解析文件，如果是`gzip`文件，浏览器会先进行解压（老IE不支持gzip文件），然后通过文件编码格式进行解码文件。

第三步：准备渲染进程。默认情况下，谷歌浏览器会为每个页面分配一个渲染进程，也就是说每打开一个新的页面，浏览器都会先创建一个渲染进程。

第四步：开始渲染

    1. 文件解码成功后，会进入渲染流程。此时会先根据HTML文件生成`DOM Tree`，根据CSS生成`CSSOM Tree`，如果遇到script标签，会先查询该标签是否存在标识
    2. DOM Tree中的元素并不一定所有都显示到屏幕上
    3. async标识进行并行下载并执行JS
    4. defer标识会先下载文件，然后等待HTML文件执行完毕之后，按序执行
    5. 如果都没有 标识，就会阻塞渲染流程，直到JS文件执行完毕
    6. 合并DOM Tree 和 CSSOM Tree 生成Render Tree，Render Tree中的元素才是最后渲染到屏幕中的元素
    7. 在Render Tree生成的过程中，浏览器就会调用GPU开始绘制，合成图层，将内容显示到屏幕。