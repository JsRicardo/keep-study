# 首屏加载时间优化

如何进行首屏加载时间优化，这个问题很大，主要还是分成两个部分：加载阶段，交互阶段

## 1、加载阶段

加载阶段影响网页首次渲染的关键资源几个指标：个数、大小、RTT（round trip time）。

加载阶段前端能做的主要还是处理资源加载数量和大小，减少关键资源RTT时间来做。

### 减少加载资源数量和大小

- 懒加载

提到减少加载资源数量，很容易就会想到懒加载。懒加载的思想其实也是分页的一种应用。这在现代设计的瀑布流排版中非常常见，诸如抖音的视频加载，谷歌相册，微博图片广场等等。。。
核心就是只加载屏幕可视区域，和超出可视区域一屏，两屏的内容，减少加载资源的数量，让首屏更快的渲染出来。

- webpack合/拆包

在平常开发中，使用脚手架搭建的项目，打包出来的包一般是会比较大的，特别是引用了很多的库，像UI库、图形处理库、Echarts等，打包出来的包会非常恐怖，这会大大的加长首屏渲染时间。

处理方式通常都是，将项目中的不变资源采用CDN的方式引入，比如vue.js 、 elmentui.js 、 echarts.js...

以Vue项目为例分析：

打包时输入`npm run build -- --report`可以得到一个report.html，可以用来分析文件依赖，看看那些文件是不需要被打包，可以使用CDN资源的。

压缩资源：

    tree-shaking：去除没用过的代码
    UglifyJsPlugin：压缩代码
    ExtractTextPlugin：提取css文件出来
    配置devServer的compress选项为true开启gzip

### 减少关键资源RTT时间

开启gzip压缩，使用CDN边缘节点（具体在网络篇中详解）

开启gzip压缩需要浏览器支持gzip文件，Nginx也需要相应的配置

- 预加载 [preload](https://juejin.im/post/5ddba3e251882572fc199875)

preload的特点
    
    提前加载资源
    资源的加载和执行分离
    不会延迟网页的load事件（除非 Preload 资源刚好是阻塞 window 加载的资源）

## 2、交互阶段

交互阶段的优化主要是指渲染进程渲染帧速度。如何让单个帧生成的速度变快呢？

### JS优化
JS代码不可占用主线程太久，与首屏无关的脚本加上延后处理（aysnc/defer）属性，与DOM无关的交给Web Worker。

避免频繁的垃圾回收。（尽量避免临时垃圾数据，优化存储结构，避免小颗粒对象产生）

### CSS优化
CSS用对选择器（尽可能绑定Class或Id）,否则会遍历多次。

### 动画优化
首屏渲染中如果有动画，加上will-change属性，浏览器会开辟新的层处理（触发合成机制）

### 布局
避免强制同步布局，添加 删除dom后计算样式布局是在另外一个任务中执行的，这时候获取样式信息，会将其变成同步任务。

避免布局抖动

### 异步加载非关键资源优化
图片懒加载

以谷歌相册的图片加载为例：

谷歌相册采用的方案是：先加载用户可视区域的一屏图片，预加载下一屏的图片，占位的加载再下屏的图片。

用户上传的图片大多是各种设备拍摄的位图，这种图片一般都比较的大，这会非常的消耗网络资源，那么在加载的时候为了体验就应该减小加载的体积。（虽然图片加载不会影响页面首次渲染，但是出现空页面，图片一下跳出来是非常影响体验感的）

这里谷歌采用的方案是，先加载一张缩略图，把他根据原图的比例放大，那么这张图就会模糊，但是这个时候排版已经出来了，用户能够看到画面了。接着开始加载清晰的原图，当原图加载完毕后，用这张原图替换缩略图，这样的话我们在加载首屏的时候，只加载了缩略图，数据量是非常小的，有效的提高了首屏加载时间。
